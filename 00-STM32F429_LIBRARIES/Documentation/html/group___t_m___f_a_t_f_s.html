<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>TM STM32F4xx Libraries: TM_FATFS</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TM STM32F4xx Libraries
   &#160;<span id="projectnumber">v1.0.0</span>
   </div>
   <div id="projectbrief">Libraries for STM32F4xx devices from Tilen Majerle</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___t_m___f_a_t_f_s.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Modules</a>  </div>
  <div class="headertitle">
<div class="title">TM_FATFS<div class="ingroups"><a class="el" href="group___t_m___s_t_m32_f4xx___libraries.html">TM_STM32F4xx_Libraries</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>FATFS implementation for STM32F4xx devices - <a href="http://stm32f4-discovery.com/2014/07/library-21-read-sd-card-fatfs-stm32f4xx-devices/">http://stm32f4-discovery.com/2014/07/library-21-read-sd-card-fatfs-stm32f4xx-devices/</a> - <a href="http://stm32f4-discovery.com/2014/08/library-29-usb-msc-host-usb-flash-drive-stm32f4xx-devices">http://stm32f4-discovery.com/2014/08/library-29-usb-msc-host-usb-flash-drive-stm32f4xx-devices</a>.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Modules</h2></td></tr>
<tr class="memitem:group___t_m___f_a_t_f_s___macros"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___t_m___f_a_t_f_s___macros.html">TM_FATFS_Macros</a></td></tr>
<tr class="memdesc:group___t_m___f_a_t_f_s___macros"><td class="mdescLeft">&#160;</td><td class="mdescRight">Library defines. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group___t_m___f_a_t_f_s___functions"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___t_m___f_a_t_f_s___functions.html">TM_FATFS_Functions</a></td></tr>
<tr class="memdesc:group___t_m___f_a_t_f_s___functions"><td class="mdescLeft">&#160;</td><td class="mdescRight">Library Functions. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>FATFS implementation for STM32F4xx devices - <a href="http://stm32f4-discovery.com/2014/07/library-21-read-sd-card-fatfs-stm32f4xx-devices/">http://stm32f4-discovery.com/2014/07/library-21-read-sd-card-fatfs-stm32f4xx-devices/</a> - <a href="http://stm32f4-discovery.com/2014/08/library-29-usb-msc-host-usb-flash-drive-stm32f4xx-devices">http://stm32f4-discovery.com/2014/08/library-29-usb-msc-host-usb-flash-drive-stm32f4xx-devices</a>. </p>
<p>FatFs implementation for STM32F4xx devices</p>
<p>This library uses Chan's Fatfs implementation.</p>
<p>This library is only for communication. To work with files, you have to look at Chan's FatFs manual, link below: <a href="http://elm-chan.org/fsw/ff/00index_e.html">http://elm-chan.org/fsw/ff/00index_e.html</a></p>
<p>You can work with SPI or SDIO protocol to interface SDcard.</p>
<dl class="section user"><dt>SDCARD pinouts</dt><dd></dd></dl>
<p>Library works with SPI or SDIO mode. Also, when in SDIO mode, you can set to 1- or 4-bit mode. By default, SDIO with 4-bit mode is used, so you will look into right column on table below.</p>
<p>SD CARD PINS</p>
<pre class="fragment">   _________________
  / 1 2 3 4 5 6 7 8 |  NR   |SDIO INTERFACE                                     |SPI INTERFACE
 /                  |       |NAME       STM32F4XX       DESCRIPTION             |NAME   STM32F4XX   DESCRIPTION 
/ 9                 |       |           4-BIT   1-BIT                           | 
|                   |       |                                                   | 
|                   |   1   |CD/DAT3    PC11    -       Connector data line 3   |CS     PB5         Chip select for SPI 
|                   |   2   |CMD        PD2     PD2     Command/Response line   |MOSI   PA7         Data input for SPI 
|                   |   3   |VSS1       GND     GND     GND                     |VSS1   GND         GND 
|   SD CARD Pinout  |   4   |VDD        3.3V    3.3V    3.3V Power supply       |VDD    3.3V        3.3V Power supply 
|                   |   5   |CLK        PC12    PC12    Clock                   |SCK    PA5         Clock for SPI 
|                   |   6   |VSS2       GND     GND     GND                     |VSS2   GND         GND 
|                   |   7   |DAT0       PC8     PC8     Connector data line 0   |MISO   PA6         Data output for SPI 
|                   |   8   |DAT1       PC9     -       Connector data line 1   |-      -           - 
|___________________|   9   |DAT2       PC10    -       Connector data line 2   |-      -           - 
</pre><dl class="section user"><dt>SDIO Communication</dt><dd></dd></dl>
<p>By default, SDIO with 4-bit communication is used. If you want to use SDIO 1-bit communication, set defines below in your defines.h file:</p>
<pre class="fragment">//Set SDIO with 1-bit communication
#define FATFS_SDIO_4BIT   0
</pre><p>For SDIO communication, you will need at least these files:</p>
<pre class="fragment">- tm_stm32f4_fatfs.h
- tm_stm32f4_fatfs.c
- fatfs/diskio.h
- fatfs/diskio.c
- fatfs/ff.h
- fatfs/ff.c
- fatfs/ffconf.h
- fatfs/integer.h
- fatfs/option/syscall.c
- fatfs/option/unicode.c
- fatfs/drivers/fatfs_sd_sdio.h
- fatfs/drivers/fatfs_sd_sdio.c
</pre><dl class="section user"><dt>SPI Communication</dt><dd></dd></dl>
<p>Or, if you want to use SPI communication, you have to add lines below in your defines.h file</p>
<pre class="fragment">//Enable SPI communication, disable SDIO
#define FATFS_USE_SDIO   0
</pre><p>Files, needed for SPI:</p>
<pre class="fragment">- tm_stm32f4_fatfs.h
- tm_stm32f4_fatfs.c
- fatfs/diskio.h
- fatfs/diskio.c
- fatfs/ff.h
- fatfs/ff.c
- fatfs/ffconf.h
- fatfs/integer.h
- fatfs/option/syscall.c
- fatfs/option/unicode.c
- fatfs/drivers/fatfs_sd.h
- fatfs/drivers/fatfs_sd.c
</pre><dl class="section user"><dt>Overwriting default pinout</dt><dd></dd></dl>
<p>SDIO interface pins are fixed, and can not be changed. If you want to change SPI pins, you have to set these defines in your defines.h file:</p>
<pre class="fragment">//Set your SPI, for corresponding pins look at TM SPI library
#define FATFS_SPI               SPI1
#define FATFS_SPI_PINSPACK      TM_SPI_PinsPack_1
    
//Set your CS pin for SPI           
#define FATFS_CS_PORT           GPIOB
#define FATFS_CS_PIN            GPIO_PIN_5
</pre><dl class="section user"><dt>Write protect and Card detect pins</dt><dd></dd></dl>
<p>Library has support for Write protect and Card detect pins. This two pins are by default on pins below.</p>
<p>They are the same for any communication used, and are disabled by default.</p>
<pre class="fragment">NAME    STM32F4XX   DESCRIPTION
    
WP      PB7         Write protect pin. Pin low when write is enabled
CD      PB6         Card detect pin. Pin low when card detected
</pre><p>Like I said before, these 2 pins are disabled by default. If you want to use it, you have to add 2 lines in your defines.h file:</p>
<pre class="fragment">//Enable Card detect pin
#define FATFS_USE_DETECT_PIN          1

//Enable Write protect pin
#define FATFS_USE_WRITEPROTECT_PIN    1
</pre><p>WP and CD pins are now enabled with default configuration.</p>
<p>Add lines below to your defines.h file only if you want to overwrite default pin settings:</p>
<pre class="fragment">//Default CD pin            
#define FATFS_USE_DETECT_PIN_PORT          GPIOB
#define FATFS_USE_DETECT_PIN_PIN           GPIO_PIN_6

//Default WP pin            
#define FATFS_USE_WRITEPROTECT_PIN_PORT    GPIOB
#define FATFS_USE_WRITEPROTECT_PIN_PIN     GPIO_PIN_7
</pre><dl class="section user"><dt>Timing function for files</dt><dd></dd></dl>
<p>FatFs uses function get_fattime() for time, to set timestamp for files, when they were edited or created.</p>
<p>By default, function returns 0, but if you want to create your own function, you have to set defines in defines.h file:</p>
<pre class="fragment">//Use custom get_fattime() function
#define FATFS_CUSTOM_FATTIME    1
</pre><p>And then somewhere in your project, add function like below:</p>
<pre class="fragment">//Use custom get_fattime function
//Implement RTC get time here if you need it
DWORD get_fattime (void) {
    //Get your time from RTC or something like that
    
    return    ((DWORD)(2014 - 1980) &lt;&lt; 25)  // Year 2014
            | ((DWORD)7 &lt;&lt; 21)              // Month 7
            | ((DWORD)10 &lt;&lt; 16)             // Mday 10
            | ((DWORD)16 &lt;&lt; 11)             // Hour 16
            | ((DWORD)0 &lt;&lt; 5)               // Min 0
            | ((DWORD)0 &gt;&gt; 1);              // Sec 0
}
</pre> <hr/>
 <h2>Version v1.2 </h2>
<p>Added support for USB MSC HOST interface with FatFS library. More about, how to configure USB MSC HOST to work properly, you should take a look at my library <a class="el" href="tm__stm32f4__usb__msc__host_8h_source.html">tm_stm32f4_usb_msc_host.h</a>. There is also default pinout for USB and other stuff.</p>
<p>I will explain here, how to properly set FatFS library to work with USB.</p>
<p>Files, needed for USB communication and FatFS:</p>
<pre class="fragment">- tm_stm32f4_fatfs.h
- tm_stm32f4_fatfs.c
- fatfs/diskio.h
- fatfs/diskio.c
- fatfs/ff.h
- fatfs/ff.c
- fatfs/ffconf.h
- fatfs/integer.h
- fatfs/option/syscall.c
- fatfs/option/unicode.c
- fatfs/drivers/fatfs_usb.h
- fatfs/drivers/fatfs_usb.c
</pre><p>After you have your files included in project, open project's defines.h file and add line below:</p>
<pre class="fragment">//Enable USB in FatFS library
#define FATFS_USE_USB      1
</pre><p>This will enable USB functions to work with FatFS module. Also, when you make define 2 lines above, SD card settings become inactive.</p>
<p>If you want to use SD card and USB storage at the same time for some reason, you have to enable SD card functionality back. Add lines below in your defines.h file:</p>
<pre class="fragment">//Enable SDIO communication for SD card
#define FATFS_USE_SDIO      1

//Enable SPI communication for SD card
#define FATFS_USE_SDIO      0
</pre><p>And also, you should know, that USB has 1: partition and SD card has 0: partition. So when you mount SD card, you should use:</p>
<pre class="fragment">//Mount SD card
f_mount(&amp;sd_fs, "0:", 1);

//Mount USB storage
f_mount(&amp;usb_fs, "1:", 1);
</pre><p>This allows you to copy data from one SD card to USB and back too and use of 2 different physical drives at the same time.</p>
<dl class="section user"><dt>Changelog</dt><dd></dd></dl>
<pre class="fragment"> Version 1.6
  - March 11, 2015
  - Added support for my new GPIO library

 Version 1.5
  - February 17, 2015
  - FatFs R0.11 supported
  - Fixed some problems when using SDIO

 Version 1.4
  - December 29, 2014
  - Support for truncate file from beginning

 Version 1.3
  - December 06, 2014
  - FatFs R0.10C supported

 Version 1.2
  - August 28, 2014
  - Added support for USB

 Version 1.0
  - First release
</pre><dl class="section user"><dt>Dependencies</dt><dd></dd></dl>
<pre class="fragment"> - STM32F4xx
 - STM32F4xx RCC
 - STM32F4xx GPIO
 - STM32Fx44 SPI    (only when SPI)
 - STM32F4xx DMA    (only when SDIO)
 - STM32Fx44 SDIO   (only when SDIO)
 - MISC             (only when SDIO)
 - defines.h
 - TM SPI           (only when SPI)
 - TM DELAY         (only when SPI)
 - TM GPIO
 - FatFS by Chan
</pre> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Mar 31 2015 14:43:34 for TM STM32F4xx Libraries by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
